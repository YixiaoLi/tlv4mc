\documentclass[a4j]{jsarticle}
\usepackage[dvipdfmx]{graphicx}
%\usepackage[dvips]{graphicx}
\usepackage{ascmac}
\newcommand{\figref}[1]{図\ref{#1}}

\title{組込みRTOS向けアプリケーション開発支援ツール\\
TLV（トレース ログ ヴィジュアライザー）\\
フェーズ4\\
アプリログ拡張外部仕様書}
\begin{document}
\maketitle
\titlepage

\section*{改訂履歴}
\begin{table}[h]
 \centering
 \begin{tabular}{|c|c|c|c|} \hline
  版番& 日付&    更新内容& 更新者\\ \hline\hline
  1.0 & 09/6/22& 新規作成& 柳澤大祐\\ \hline
 \end{tabular}
\end{table}
\clearpage

\tableofcontents
\clearpage

\section{はじめに}
\subsection{本書の目的}
本書の目的は、文部科学省先導的ITスペシャリスト育成推進プログラム「OJLに
  よる最先端技術適応能力を持つIT人材育成拠点の形成」プロジェクトにおけ
る、OJL科目ソフトウェア工学実践研究の研究テーマである「組込みRTOS向けア
  プリケーション開発支援ツールの開発」に対して、その開発するソフトウェ
ア拡張の外部仕様を記述することである。

本書は特に、フェーズ4におけるアプリログ拡張の外部仕様に関する記述を行う。

\subsection{本書の適用範囲}
本書は、組込みMPRTOS向けアプリケーション開発支援ツールの開発プロジェク
ト（以下本プロジェクト）のフェーズ4におけるアプリログ拡張の外部仕様に関する
記述を行う。

\subsection{用語の定義/略語の説明}

\begin{table}[h]
 \centering
 \caption{用語定義}
 \begin{tabular}{|p{8em}|p{34em}|} \hline
  用語・略語& 定義・説明\\ \hline \hline
  TLV& Trace Log Visualizer\\ \hline
  MPRTOS& マルチプロセッサ対応リアルタイムオペレーティングシステム\\
  \hline
  トレースログファイル&
      RTOSのトレースログ機能を用いて出力したトレースログや、
      シミュレータなどが出力するトレースログをファイルにしたもの\\
  \hline
  標準形式トレースログファイル&
      本ソフトウェアが扱うことの出来る形式をもつトレースログファイル。
      各種トレースログファイルは、この共通形式トレースログファイルに
      変換することにより本ソフトウェアで扱うことが出来るようになる。 \\
  \hline
  変換ルール  &
  トレースログファイルを標準形式トレースログファイルに変換する際に用いられるルール。
  \\
  \hline
  可視化ルール  &
  標準形式トレースログファイルを可視化する際に用いられるルール。
  \\
  \hline
  TLVファイル &
      本ソフトウェアが中間形式として用いるファイル。
      前述の標準形式トレースログファイルは、このTLVファイルの一部である。 \\
  \hline
 \end{tabular}
\end{table}

\subsection{概要}
本書では、組込みMPRTOS向けアプリケーション開発支援ツールの
ソフトウェアの仕様を記述する。
本書は特に、フェーズ4におけるアプリログ拡張の外部仕様に関する記述を行う。

\clearpage
\section{概要説明}
これまでに寄せられたTLVへの要望として、printfデバッグを行いたいというものがあった。
一般的なprintfデバッグによる出力をTLVのタイムライン上に表示させることによって、
メッセージが出力されたときのタスク状態などが一目でわかるという利点がある。
この要望を実現するものがアプリログ拡張である。

また、関数の呼び出し関係や列挙型変数の値などを、タスク状態のように
可視化したいという要望があったため、これに対してもアプリログ拡張で対応する。

\begin{figure}[h]
  \begin{center}
    \includegraphics{syslog_image.png}
    %\includegraphics{syslog_image.eps}
  \end{center}
  \caption{アプリログ拡張イメージ}
  \label{fig:applogimage}
\end{figure}

\subsection{アプリログ拡張}
今までのTLVでは、任意の文字列を可視化することができないので、printfデバッグを行えない。
そこで、フェーズ4での要求として任意文字列を可視化することが挙げられている。

例えば、\verb|[123456789] printf foobarbaz.|のようなログがあった場合、時刻123456789の位置にfoobarbazというメッセージが表示されるような可視化を想定する。

本拡張では、以下の3つの可視化方法を提供する。
また、そのそれぞれはタスクに関連するものとしないものの2通り存在する。
\begin{description}
  \item[文字列可視化] 任意文字列をTLV上に表示
  \item[ユーザ定義状態可視化] タスクの状態表示のように、ユーザが任意に決めた状態を可視化
  \item[ユーザ定義状態可視化（端点付き）] 上記の可視化に加え、開始と終了があるもの。関数コールを想定
\end{description}

TOPPERSカーネルでは、ユーザアプリケーションからのログ出力はsyslog関数によって行う。
よって、ユーザアプリケーション側からの利用はsyslog関数や、別に用意するAPIを介して行うものとする。

本機能をユーザアプリケーションから利用する場合は、以下の手順で行う。
\begin{enumerate}
  \item TLVのリソースファイルに追記
  \item アプリケーションにログ出力関数コールを追加（syslog関数または本拡張で提供するAPI）
  \item アプリケーションを実行
  \item TLVを実行
\end{enumerate}

また、今回の拡張はTLV本体には手を入れず、可視化ルールなどの記述のみで
実現することとした。

\clearpage
\section{文字列可視化}
文字列の可視化には、タスクに関連するものとそうでないものがある。
以降、タスクに関連する文字列可視化を\textbf{タスク文字列可視化}、タスクに関連しない文字列可視化を\textbf{文字列可視化}と呼ぶ。

タスク文字列可視化は、タスクの属性として定義することで、
現在のタスク状態表示などの上に重ねて表示する。
文字列可視化は、それ専用の行で表示する。
\subsection{入力}
TLVが認識する方法でログを出力する方法は2通りある。
ひとつが、TOPPERSカーネルのsyslog関数を呼ぶ方法である。
この方法は、指定されたフォーマットでsyslog関数を呼ぶことで、
TLV認識可能なフォーマットのログを出力できる。
もうひとつが、本スクリプト拡張で用意するAPIを利用する方法である。
関数の引数に出力したい内容を指定して呼び出して利用する。
この方法の場合、syslog関数のようにフォーマットを気にする必要がない。

斜体で表示されている箇所は、アプリケーション開発者が望む値に置換する場所であることを示している。
参考までに、どのようなログが出力されるかを付した。

\paragraph{書式}
文字列可視化をするためのログ出力方法を記述する。
\begin{itembox}[l]{文字列可視化のログ書式}
  \paragraph{syslog}
  syslog("applog id \%s \%s.",\textit{rid},\textit{str});
  \paragraph{API}
  void applog\_str(const char *\textit{rid}, const char *\textit{str})
  \paragraph{ログ出力}
  \verb|[| \textit{time} \verb|]| applog id \textit{rid} \textit{str}. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{rid}] 表示行ID \verb|[^\. ]+|
    \item[\textit{str}] 出力文字列 \verb|[^\.]*|
  \end{description}
\end{itembox}
\begin{itembox}[l]{タスク文字列可視化のログ書式}
  \paragraph{syslog}
  syslog("applog task \%d \%s.",\textit{tid},\textit{str});
  \paragraph{API}
  void applog\_strtsk(const int \textit{tid}, const char *\textit{str})
  \paragraph{ログ出力}
  \verb|[| \textit{time} \verb|]| applog task \textit{tid} \textit{str}. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{tid}] タスクID \verb|[0-9]+|
    \item[\textit{str}] 出力文字列 \verb|[^\.]*|
  \end{description}
\end{itembox}

\paragraph{リソースファイル書式}
以下の記述は、文字列可視化を行う際に、ユーザがリソースファイルに追加するものである。タスク文字列可視化では不要である。
\begin{itembox}[l]{文字列可視化リソースファイル書式}
  \begin{verbatim}
"rowname":{
    "Type":"ApplogStr",
    "Attributes":{
        "id":"rid",
        "str":""
    }
}\end{verbatim}
  \begin{description}
    \item[\textit{rowname}] 文字列可視化行の名前 \verb|[^"]+|
    \item[\textit{rid}] 文字列可視化行のID \verb|[^"]+|
  \end{description}
\end{itembox}

\subsection{出力}
以下では、文字列の可視化方法を定義する。

\paragraph{文字列可視化}
まず、文字列可視化を示す。

\begin{figure}
  \begin{center}
    \includegraphics[width=15cm]{applog_str.png}
    %\includegraphics[width=15cm]{applog_str.eps}
  \end{center}
  \caption{文字列可視化}
  \label{fig:str}
\end{figure}

\begin{verbatim}
syslog("applog id 1 foo.");
\end{verbatim}
または
\begin{verbatim}
applog_str("1", "foo");
\end{verbatim}
このようなログ出力を行った場合、\figref{fig:str}のように可視化を行う。

\paragraph{タスク文字列可視化}
次に、タスクに関連する文字列の可視化を示す。

\begin{figure}
  \begin{center}
    \includegraphics[width=15cm]{applog_strtsk.png}
    %\includegraphics[width=15cm]{applog_strtsk.eps}
  \end{center}
  \caption{タスク文字列の可視化}
  \label{fig:strtsk}
\end{figure}

\begin{verbatim}
syslog("applog task 1 FOO.");
\end{verbatim}
または
\begin{verbatim}
applog_tsk("1", "FOO");
\end{verbatim}
このようなログ出力を行った場合、\figref{fig:strtsk}のように可視化を行う。

タスク文字列の可視化がタスクの状態やシステムコールと重複して見づらい場合は、
ユーザが不要な可視化項目を可視化しないようにすることで見やすいよう設定することとする。

\clearpage
\section{ユーザ定義状態可視化}
以下に、ユーザ定義状態の可視化方法を説明する。
TLVは、変換ルール・可視化ルールとして
あらかじめ状態数の定められた状態を提供する。
今回は4状態および8状態の集合とする。
ユーザは、可視化したい状態変数の状態数に応じたものを選び、
どの状態が何を意味するか決定し、
アプリケーションにログ出力コードを埋め込む。

\subsection{入力}

\paragraph{書式}
ユーザ定義状態可視化をするためのログ出力方法を記述する。
\begin{itembox}[l]{ユーザ定義状態可視化のログ書式}
  \paragraph{syslog}
  syslog("applog state id \%s \%d.",\textit{rid},\textit{sid});
  \paragraph{API}
  void applog\_stt(const char *\textit{rid}, const int \textit{sid})
  \paragraph{ログ出力}
  \verb|[| \textit{time} \verb|]| applog state id \textit{rid} \textit{sid}. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{rid}] 表示行ID \verb|[^\. ]+|
    \item[\textit{sid}] 状態 \verb|[0-9]+|
  \end{description}
\end{itembox}
\begin{itembox}[l]{タスクユーザ定義状態可視化のログ書式}
  \paragraph{syslog}
  syslog("applog state task \%d \%d.",\textit{tid},\textit{sid});
  \paragraph{API}
  void applog\_stttsk(const int \textit{tid}, const int \textit{sid})
  \paragraph{ログ出力}
  \verb|[| \textit{time} \verb|]| applog state task \textit{tid} \textit{sid}. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{tid}] タスクID \verb|[0-9]+|
    \item[\textit{sid}] 状態 \verb|[0-9]+|
  \end{description}
\end{itembox}

\paragraph{リソースファイル書式}
以下の記述は、ユーザ定義状態可視化を行う際に、ユーザがリソースファイルに追加するものである。タスクユーザ定義状態可視化では不要である。
\begin{itembox}[l]{ユーザ定義状態可視化リソースファイル書式（4状態の場合）}
  \begin{verbatim}
"rowname":{
    "Type":"Applog4State",
    "Attributes":{
        "id":"rid",
        "state":sid
    }
}\end{verbatim}
  \begin{description}
    \item[\textit{rowname}] 文字列可視化行の名前 \verb|[^"]+|
    \item[\textit{rid}] 文字列可視化行のID \verb|[^"]+|
    \item[\textit{sid}] 初期状態 \verb|[0-9]+|
  \end{description}
\end{itembox}

\subsection{出力}
以下では、文字列の可視化方法を定義する。

\paragraph{ユーザ定義状態可視化}
まず、ユーザ定義状態可視化を示す。

\begin{figure}
  \begin{center}
    \includegraphics[width=15cm]{userstate.png}
  \end{center}
  \caption{ユーザ定義状態可視化}
  \label{fig:usrstt}
\end{figure}

\begin{verbatim}
syslog("applog state id 1 0.");
syslog("applog state id 1 1.");
syslog("applog state id 1 2.");
syslog("applog state id 1 1.");
syslog("applog state id 1 0.");
\end{verbatim}
または
\begin{verbatim}
applog_stt("1", 0);
applog_stt("1", 1);
applog_stt("1", 2);
applog_stt("1", 1);
applog_stt("1", 0);
\end{verbatim}
このようなログ出力を行った場合、\figref{fig:usrstt}のように可視化を行う。


\clearpage
\section{ユーザ定義状態可視化（端点付き）}
以下に、端点付きのユーザ定義状態の可視化方法を説明する。
通常との違いは、状態の開始時と終了時に端点がついている点である。
これにより関数コールなどを表現する。
\subsection{入力}

\paragraph{書式}
端点付きユーザ定義状態可視化をするためのログ出力方法を記述する。
\begin{itembox}[l]{端点付きユーザ定義状態可視化のログ書式}
  \paragraph{syslog}　\\
  syslog("applog state id \%s \%d start.",\textit{rid},\textit{sid}); \\
  syslog("applog state id \%s \%d end.",\textit{rid},\textit{sid});
  \paragraph{API}　\\
  void applog\_stt\_st(const char *\textit{rid}, const int \textit{sid}) \\
  void applog\_stt\_en(const char *\textit{rid}, const int \textit{sid})
  \paragraph{ログ出力}　\\
  \verb|[| \textit{time} \verb|]| applog state id \textit{rid} \textit{sid} start. \\
  \verb|[| \textit{time} \verb|]| applog state id \textit{rid} \textit{sid} end. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{rid}] 表示行ID \verb|[^\. ]+|
    \item[\textit{sid}] 状態 \verb|[0-9]+|
  \end{description}
\end{itembox}
\begin{itembox}[l]{端点付きタスクユーザ定義状態可視化のログ書式}
  \paragraph{syslog}　\\
  syslog("applog state task \%s \%d start.",\textit{tid},\textit{sid}); \\
  syslog("applog state task \%s \%d end.",\textit{tid},\textit{sid});
  \paragraph{API}　\\
  void applog\_stttsk\_st(const char *\textit{tid}, const int \textit{sid}) \\
  void applog\_stttsk\_en(const char *\textit{tid}, const int \textit{sid})
  \paragraph{ログ出力}　\\
  \verb|[| \textit{time} \verb|]| applog state tsk \textit{tid} \textit{sid} start. \\
  \verb|[| \textit{time} \verb|]| applog state tsk \textit{tid} \textit{sid} end. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{tid}] タスクID \verb|[0-9]+|
    \item[\textit{sid}] 状態 \verb|[0-9]+|
  \end{description}
\end{itembox}

\paragraph{リソースファイル書式}
以下の記述は、端点付きユーザ定義状態可視化を行う際に、ユーザがリソースファイルに追加するものである。端点付きタスクユーザ定義状態可視化では不要である。
\begin{itembox}[l]{ユーザ定義状態可視化リソースファイル書式（4状態の場合）}
  \begin{verbatim}
"rowname":{
    "Type":"Applog4StateTerminal",
    "Attributes":{
        "id":"rid",
        "state":sid
    }
}\end{verbatim}
  \begin{description}
    \item[\textit{rowname}] 文字列可視化行の名前 \verb|[^"]+|
    \item[\textit{rid}] 文字列可視化行のID \verb|[^"]+|
    \item[\textit{sid}] 初期状態 \verb|[0-9]+|
  \end{description}
\end{itembox}

\subsection{出力}
以下では、端点付きユーザ定義状態の可視化方法を定義する。
端点付きタスクユーザ定義状態に関しては省略する。

\begin{figure}
  \begin{center}
    \includegraphics[width=15cm]{userstate_terminal.png}
  \end{center}
  \caption{ユーザ定義状態可視化}
  \label{fig:usrsttter}
\end{figure}

\begin{verbatim}
syslog("applog state id 1 0 start.");
syslog("applog state id 1 1 start.");
syslog("applog state id 1 2 start.");
syslog("applog state id 1 2 end.");
syslog("applog state id 1 1 end.");
syslog("applog state id 1 0 end.");
\end{verbatim}
または
\begin{verbatim}
applog_stt_st("1", 0);
applog_stt_st("1", 1);
applog_stt_st("1", 2);
applog_stt_en("1", 2);
applog_stt_en("1", 1);
applog_stt_en("1", 0);
\end{verbatim}
このようなログ出力を行った場合、\figref{fig:usrsttter}のように可視化を行う。
\clearpage
\section*{参考文献}

\end{document}
