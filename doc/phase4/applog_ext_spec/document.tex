\documentclass[a4j]{jsarticle}
\usepackage[dviout]{graphicx}
\usepackage{ascmac}
\newcommand{\figref}[1]{図\ref{#1}}

\title{組込みRTOS向けアプリケーション開発支援ツール\\
TLV（トレース ログ ヴィジュアライザー）\\
フェーズ4\\
アプリログ拡張外部仕様書}
\begin{document}
\maketitle
\titlepage

\section*{改訂履歴}
\begin{table}[h]
 \centering
 \begin{tabular}{|c|c|c|c|} \hline
  版番& 日付&    更新内容& 更新者\\ \hline\hline
  1.0 & 09/6/2& 新規作成& 柳澤大祐\\ \hline
 \end{tabular}
\end{table}
\clearpage

\tableofcontents
\clearpage

\section{はじめに}
\subsection{本書の目的}
本書の目的は、文部科学省先導的ITスペシャリスト育成推進プログラム「OJLに
  よる最先端技術適応能力を持つIT人材育成拠点の形成」プロジェクトにおけ
る、OJL科目ソフトウェア工学実践研究の研究テーマである「組込みRTOS向けア
  プリケーション開発支援ツールの開発」に対して、その開発するソフトウェ
ア拡張の外部仕様を記述することである。

本書は特に、フェーズ4におけるアプリログ拡張の外部仕様に関する記述を行う。

\subsection{本書の適用範囲}
本書は、組込みMPRTOS向けアプリケーション開発支援ツールの開発プロジェク
ト（以下本プロジェクト）のフェーズ4におけるアプリログ拡張の外部仕様に関する
記述を行う。

\subsection{用語の定義/略語の説明}

\begin{table}[h]
 \centering
 \caption{用語定義}
 \begin{tabular}{|p{8em}|p{36em}|} \hline
  用語・略語& 定義・説明\\ \hline \hline
  TLV& Trace Log Visualizer\\ \hline
  MPRTOS& マルチプロセッサ対応リアルタイムオペレーティングシステム\\
  \hline
  トレースログファイル&
      RTOSのトレースログ機能を用いて出力したトレースログや、
      シミュレータなどが出力するトレースログをファイルにしたもの\\
  \hline
  標準形式トレースログファイル&
      本ソフトウェアが扱うことの出来る形式をもつトレースログファイル。
      各種トレースログファイルは、この共通形式トレースログファイルに
      変換することにより本ソフトウェアで扱うことが出来るようになる。 \\
  \hline
  変換ルール  &
  トレースログファイルを標準形式トレースログファイルに変換する際に用いられるルール。
  \\
  \hline
  可視化ルール  &
  標準形式トレースログファイルを可視化する際に用いられるルール。
  \\
  \hline
  TLVファイル &
      本ソフトウェアが中間形式として用いるファイル。
      前述の標準形式トレースログファイルは、このTLVファイルの一部である。 \\
  \hline
 \end{tabular}
\end{table}

\subsection{概要}
本書では、組込みMPRTOS向けアプリケーション開発支援ツールの
ソフトウェアの仕様を記述する。
本書は特に、フェーズ4におけるアプリログ拡張の外部仕様に関する記述を行う。

\clearpage
\section{概要説明}
これまでに寄せられたTLVへの要望として、printfデバッグを行いたいというものがあった。
これは、一般的なprintfデバッグによる出力をTLVのタイムライン上に表示させることによって、
メッセージが出力されたときのタスク状態などが一目でわかるため有用であると

\subsection{アプリログ拡張}
アプリケーションのデバッグには、一般的にprintfデバッグと呼ばれる手法が有効である。
今までのTLVでは、任意の文字列を可視化することができないので、printfデバッグを行えない。
そこで、フェーズ4での要求として任意文字列を可視化することが挙げられている。

例えば、\verb|[123456789] printf foobarbaz.|のようなログがあった場合、時刻123456789の位置にfoobarbazというメッセージが表示されるような可視化を想定する。

本拡張では、以下の3つの可視化方法を提供する。
\begin{description}
  \item[文字列可視化] 任意文字列をTLV上に表示
  \item[ユーザ定義状態可視化] タスクの状態表示のように、ユーザが任意に決めた状態を可視化
  \item[ユーザ定義状態可視化（端点付き）] 上記の可視化に加え、開始と終了があるもの。関数コールを想定
\end{description}

TOPPERSカーネルでは、ユーザアプリケーションからのログ出力はsyslog関数によって行う。
よって、ユーザアプリケーション側からの利用はsyslog関数や、別に用意するAPIを介して行うものとする。

本機能をユーザアプリケーションから利用する場合は、以下の手順で行う。
\begin{enumerate}
  \item TLVのリソースファイルに追記
  \item アプリケーションにログ出力関数コールを追加（syslog関数または本拡張で提供するAPI）
  \item アプリケーションを実行
  \item TLVを実行
\end{enumerate}

また、今回の拡張はTLV本体には手を入れず、可視化ルールなどの記述のみで
実現することとした。

\subsection{文字列可視化}
文字列の可視化には、タスクに関連するものとそうでないものがある。
以降、タスクに関連する文字列可視化を\textbf{タスク文字列可視化}、タスクに関連しない文字列可視化を\textbf{文字列可視化}と呼ぶ。

タスク文字列可視化は、タスクの属性として定義することで、
現在のタスク状態表示などの上に重ねて表示する。
文字列可視化は、それ専用の行で表示する。
\subsubsection{入力}
斜体で表示されている箇所は、アプリケーション開発者が望む値に置換する場所であることを示している。

\paragraph{ログ書式} TLVへ入力するログの書式を定義する。
\begin{itembox}[l]{文字列可視化のログ書式}
  \verb|[| \textit{time} \verb|]| applog \textit{str}. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{str}] 出力文字列 \verb|[^\.]*|
  \end{description}
\end{itembox}
\begin{itembox}[l]{タスク文字列可視化のログ書式}
  \verb|[| \textit{time} \verb|]| task \textit{tid} applog \textit{str}. 
  \begin{description}
    \item[\textit{time}] 時刻 \verb|[0-9a-zA-Z]+|
    \item[\textit{tid}] タスクID \verb|[0-9]+|
    \item[\textit{str}] 出力文字列 \verb|[^\.]*|
  \end{description}
\end{itembox}

\paragraph{リソースファイル書式}
以下の記述は、タスクとは関係ない文字列出力を行う際に、ユーザがリソースファイルに追加するものである。
\begin{itembox}[l]{文字列可視化リソースファイル書式}
  \begin{verbatim}
"rowname":{
    "Type":"ApplogStr",
    "Attributes":{
        "str":""
    }
}\end{verbatim}
  \begin{description}
    \item[\textit{rowname}] 文字列可視化行の名前 \verb|[^"]+|
  \end{description}
\end{itembox}

\paragraph{API}
また、アプリケーション開発者の利便のために、先ほど示した形式でログを出力するC言語の関数を用意する。

\begin{itembox}[l]{文字列可視化関数}
  int applogstr(const char* str)
  \begin{description}
    \item[\textit{str}] 可視化したい文字列|
  \end{description}
\end{itembox}
\begin{itembox}[l]{タスク文字列可視化関数}
  int applogstrtsk(const char* str, const int tid)
  \begin{description}
    \item[\textit{str}] 可視化したい文字列|
    \item[\textit{tid}] タスクID
  \end{description}
\end{itembox}
\subsubsection{出力}
以下では、文字列の可視化方法を定義する。

\paragraph{文字列可視化}
まず、文字列可視化を示す。

\begin{figure}[h]
  \begin{center}
    \includegraphics[width=15cm]{applog_str.png}
  \end{center}
  \caption{文字列可視化}
  \label{fig:str}
\end{figure}

\begin{verbatim}
[9379610] applog foo.
\end{verbatim}
このようなログが出力された場合、\figref{fig:str}のように可視化を行う。

\paragraph{タスク文字列可視化}
次に、タスクに関連する文字列の可視化を示す。

\begin{figure}[h]
  \begin{center}
    \includegraphics[width=15cm]{applog_strtsk.png}
  \end{center}
  \caption{タスク文字列の可視化}
  \label{fig:strtsk}
\end{figure}

\begin{verbatim}
[10379610] task 1 syslog FOO.
\end{verbatim}
このようなログが出力された場合、\figref{fig:strtsk}のように可視化を行う。
タスクの状態やシステムコールと重複して見づらい場合は、ユーザが不要な可視化項目を可視化しないようにすることで見やすいよう設定することとする。

\subsection{ユーザ定義状態可視化}
\subsubsection{入力}

\subsubsection{出力}


\subsection{ユーザ定義状態可視化（端点付き）}
\subsubsection{入力}

\subsubsection{出力}



\section*{参考文献}

\end{document}
